
#include "RndObsGround.hh"
#include "simu_functions.hh"
#include "SwingStanceAnalysis.hh"

#include <cmath>

#define LIST_OBS_SEMI_SIZE 5

#define LIST_OBS_SIZE (2*LIST_OBS_SEMI_SIZE)

#define INIT_NB_STEPS 4

#define MIN_X_OBS_DIST 0.1
#define MAX_X_OBS_DIST 0.2
#define DIFF_MAX_MIN_X_OBS (MAX_X_OBS_DIST - MIN_X_OBS_DIST)

/*! \brief constructor
 * 
 * \param[in] mbs_data Robotran structure
 * \param[in] gait_features gait features
 * \param[in] sens_info information coming from the sensors
 */
RndObsGround::RndObsGround(MbsData *mbs_data, GaitFeatures *gait_features, SensorsInfo *sens_info): EquationGround(mbs_data, gait_features, sens_info), x_obs_r(LIST_OBS_SIZE, -100.0), x_obs_l(LIST_OBS_SIZE, -100.0)
{
	flag_first = 0;

	l_obs = 15e-3;
	h_obs = 10e-3;
}

/*! \brief destructor
 */
RndObsGround::~RndObsGround()
{

}

/*! \brief get a random distance in the [MIN_X_OBS_DIST ; MAX_X_OBS_DIST] range
 */
double RndObsGround::get_random_dist()
{
	return (MIN_X_OBS_DIST + rnd_simu() * DIFF_MAX_MIN_X_OBS);
}

/*! \brief initialize obstacles for hardcoded ground
 */
void RndObsGround::init_hardcode()
{
	double tab_l_obs[220] = {0.991736, 1.15339, 1.31315, 1.4556, 1.60926, 1.53998, 1.71804, 1.88963, 2.08724, 2.26644, 2.26064, 2.43295, 2.55646, 2.72395, 2.89949, 2.84311, 2.98128, 3.16029, 3.32453, 3.50516, 3.58408, 3.70142, 3.82298, 3.96438, 4.07933, 4.16044, 4.35357, 4.47169, 4.63224, 4.79285, 4.76393, 4.96221, 5.12816, 5.31996, 5.48249, 5.37566, 5.5441, 5.692, 5.83627, 5.94612, 6.04425, 6.2273, 6.40623, 6.58501, 6.7286, 6.53667, 6.68442, 6.84895, 7.03086, 7.17041, 7.20094, 7.32991, 7.52548, 7.66795, 7.84119, 7.76843, 7.94937, 8.08374, 8.26674, 8.42645, 8.37978, 8.56188, 8.66716, 8.83008, 8.9941, 9.00899, 9.11241, 9.23763, 9.35281, 9.4987, 9.43833, 9.55911, 9.68093, 9.81783, 9.9216, 10.1717, 10.2838, 10.4469, 10.6361, 10.8111, 10.6569, 10.7961, 10.9423, 11.1288, 11.2832, 11.2879, 11.4337, 11.5561, 11.6939, 11.8766, 12.066, 12.2023, 12.3474, 12.4891, 12.6146, 12.6526, 12.799, 12.9266, 13.075, 13.2079, 13.3244, 13.4974, 13.627, 13.7689, 13.8797, 14.0908, 14.2793, 14.4362, 14.5444, 14.6745, 14.7207, 14.8647, 15.0247, 15.1395, 15.332, 15.3341, 15.4642, 15.5912, 15.7376, 15.9096, 15.9092, 16.0402, 16.1973, 16.3149, 16.454, 16.6879, 16.8613, 17.0472, 17.1881, 17.3764, 17.1604, 17.2887, 17.4631, 17.6294, 17.8041, 17.7379, 17.885, 17.9878, 18.1472, 18.3119, 18.4101, 18.6005, 18.7068, 18.8992, 19.0305, 19.0579, 19.1769, 19.2874, 19.4714, 19.6566, 19.7631, 19.8841, 20.0482, 20.2122, 20.3926, 20.4346, 20.6344, 20.7403, 20.9065, 21.0987, 20.9269, 21.0388, 21.1983, 21.3541, 21.5499, 21.5019, 21.6971, 21.878, 21.9852, 22.1445, 22.1701, 22.3185, 22.4475, 22.6339, 22.7485, 22.7831, 22.9126, 23.0504, 23.2259, 23.4112, 23.5116, 23.6147, 23.7643, 23.9313, 24.0415, 24.1708, 24.3256, 24.4906, 24.5949, 24.7362, 24.8129, 24.9838, 25.1231, 25.2518, 25.3982, 25.3794, 25.5165, 25.6416, 25.8124, 25.9164, 25.9481, 26.1048, 26.2135, 26.3276, 26.4886, 26.6329, 26.7385, 26.8582, 26.9939, 27.1281, 27.1488, 27.3028, 27.4511, 27.5948, 27.7196, 27.7811, 27.9148, 28.032, 28.1991, 28.3469};
	double tab_r_obs[215] = {1.26917, 1.44061, 1.61403, 1.74085, 1.85861, 1.90114, 2.06936, 2.2094, 2.35021, 2.50408, 2.56645, 2.70126, 2.80139, 2.98459, 3.10194, 3.18038, 3.29706, 3.44912, 3.55521, 3.69871, 3.83113, 3.93612, 4.11929, 4.26008, 4.40589, 4.57919, 4.72378, -4.9192, 5.113, 5.24078, 5.16527, 5.28973, 5.46894, 5.66758, 5.79813, 5.72384, 5.86886, 5.98372, 6.12973, 6.31553, 6.24375, 6.41619, 6.60437, 6.73935, 6.90559, 6.96237, 7.09086, 7.25488, 7.36114, 7.48826, 7.38165, 7.48696, 7.60522, 7.72549, 7.87682, 8.05695, 8.1795, 8.31166, 8.4778, 8.63532, 8.60634, 8.79632, 8.98883, 9.09767, 9.29391, 9.27072, 9.39134, 9.54254, 9.65925, 9.80014, 9.80915, 9.92401, 10.0503, 10.164, 10.345, 10.3709, 10.5048, 10.6699, 10.7895, 10.9323, 11.0595, 11.2445, 11.4195, 11.5628, 11.6644, 11.6511, 11.7704, 11.9679, 12.1204, 12.2535, 12.3432, 12.5119, 12.6714, 12.8565, 13.0449, 13.0747, 13.2153, 13.3331, 13.4902, 13.674, 13.6585, 13.8266, 13.9567, 14.0666, 14.1872, 14.4083, 14.5367, 14.7356, 14.8774, 14.9909, 15.0226, 15.2195, 15.3525, 15.4632, 15.6172, 15.5841, 15.7429, 15.8829, 16.0508, 16.2195, 16.2653, 16.4653, 16.6328, 16.8189, 16.9608, 16.8959, 17.0296, 17.2148, 17.3263, 17.4706, 17.4317, 17.5358, 17.6693, 17.8558, 18.0277, 18.1678, 18.3145, 18.4791, 18.5885, 18.7214, 18.836, 19.0068, 19.1719, 19.3517, 19.5339, 19.5051, 19.6355, 19.8248, 19.9436, 20.0605, 20.0435, 20.1495, 20.2766, 20.4699, 20.5853, 20.6072, 20.768, 20.931, 21.0333, 21.1739, 21.2976, 21.4386, 21.5649, 21.699, 21.8588, 21.8079, 21.9438, 22.109, 22.2974, 22.4266, 22.4132, 22.5368, 22.7122, 22.8964, 23.0224, 23.0991, 23.2194, 23.3457, 23.5055, 23.6599, 23.7797, 23.908, 24.0541, 24.2282, 24.3449, 24.5595, 24.685, 24.8499, 25.0049, 25.1147, 25.0862, 25.2485, 25.4152, 25.5661, 25.6882, 25.6354, 25.8151, 25.9474, 26.1289, 26.2828, 26.3537, 26.5474, 26.7341, 26.8488, 26.9975, 26.9041, 27.0645, 27.2609, 27.3938, 27.5051, 27.6013, 27.7803, 27.8848, 28.0695, 28.23};

	for(int i=0; i<220; i++)
	{
		x_obs_l.add_value(tab_l_obs[i]);
	}

	for(int i=0; i<215; i++)
	{
		x_obs_r.add_value(tab_r_obs[i]);
	}
}

/*! \brief compute specific values for the ground model
 */
void RndObsGround::compute()
{
	double  cur_x_obs;

	SwingStanceAnalysis *swing_stance;

	swing_stance = static_cast<SwingStanceAnalysis*>(gait_features->get_feature(SWING_STANCE_FEAT));

	if (swing_stance->get_nb_steps() >= INIT_NB_STEPS)
	{
		if (swing_stance->get_flag_strike_leg(RIGHT_ID))
		{
			cur_x_obs = gait_features->get_x_last_strike_step(RIGHT_ID);

			for (int i=0; i<LIST_OBS_SEMI_SIZE; i++)
			{
				cur_x_obs += get_random_dist();
				x_obs_l.add_value(cur_x_obs);
			}
		}

		if (swing_stance->get_flag_strike_leg(LEFT_ID))
		{
			cur_x_obs = gait_features->get_x_last_strike_step(LEFT_ID);

			for (int i=0; i<LIST_OBS_SEMI_SIZE; i++)
			{
				cur_x_obs += get_random_dist();
				x_obs_r.add_value(cur_x_obs);
			}
		}
	}
}
